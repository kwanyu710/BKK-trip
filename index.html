<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ›¼è°· BKK Trip 12/23-12/28</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #FF6B6B;      /* ä¸»è‰²ï¼šç†±æƒ…ç´… */
            --secondary: #4ECDC4;    /* æ¬¡è‰²ï¼šæ¸…çˆ½ç¶  */
            --accent: #FFE66D;       /* é»ç¶´ï¼šé»ƒè‰² */
            --dark: #2D3436;
            --light: #F7F9FC;
            --card-bg: #FFFFFF;
            --nav-height: 70px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--light);
            color: var(--dark);
            margin: 0;
            padding-bottom: 100px; /* é¿é–‹åº•éƒ¨å°èˆª */
        }

        /* --- é ‚éƒ¨å°èˆª (æ—¥æœŸåˆ‡æ›) --- */
        .date-scroller {
            background: var(--card-bg);
            padding: 15px 10px;
            display: flex;
            overflow-x: auto;
            gap: 10px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .date-chip {
            flex: 0 0 auto;
            padding: 8px 16px;
            border-radius: 20px;
            background: #eee;
            color: #888;
            font-size: 14px;
            cursor: pointer;
            transition: 0.3s;
        }
        .date-chip.active {
            background: var(--dark);
            color: #fff;
            font-weight: bold;
        }

        /* --- ä¸»å®¹å™¨ --- */
        .container {
            padding: 15px;
            max-width: 800px;
            margin: 0 auto;
            display: none;
        }
        .container.active { display: block; }

        /* --- å¡ç‰‡è¨­è¨ˆ --- */
        .card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.03);
            position: relative;
            border-left: 5px solid #ccc;
        }
        
        /* å¡ç‰‡åˆ†é¡é¡è‰² */
        .type-flight { border-left-color: #0984e3; }
        .type-hotel { border-left-color: #6c5ce7; }
        .type-food { border-left-color: #e17055; }
        .type-attraction { border-left-color: #00b894; }
        .type-transport { border-left-color: #fdcb6e; }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        .time-badge {
            font-weight: 700;
            color: var(--primary);
            font-size: 1.1em;
        }
        .weather-badge {
            font-size: 0.8em;
            color: #666;
            display: flex;
            align-items: center;
            gap: 4px;
            background: #f1f2f6;
            padding: 2px 8px;
            border-radius: 12px;
        }
        .card-title {
            font-size: 1.15em;
            font-weight: bold;
            margin: 5px 0;
        }
        .card-desc {
            font-size: 0.95em;
            color: #555;
            line-height: 1.5;
            white-space: pre-wrap; /* ä¿ç•™æ›è¡Œ */
        }
        
        /* AI é‡é»æ¨™è¨˜æ¨£å¼ */
        .highlight-tag {
            background: #fff3cd;
            color: #856404;
            padding: 0 4px;
            border-radius: 4px;
            font-weight: bold;
        }
        .highlight-code {
            background: #d4edda;
            color: #155724;
            font-family: monospace;
            padding: 2px 6px;
            border-radius: 4px;
            border: 1px solid #c3e6cb;
        }

        .card-actions {
            margin-top: 12px;
            display: flex;
            gap: 10px;
            border-top: 1px solid #eee;
            padding-top: 10px;
        }
        .btn-action {
            flex: 1;
            padding: 8px;
            text-align: center;
            border-radius: 8px;
            text-decoration: none;
            font-size: 0.9em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        .btn-nav { background: #dfe6e9; color: #2d3436; }
        .btn-link { background: #e0f7fa; color: #006064; }
        .btn-edit { background: white; border: 1px solid #ddd; color: #888; width: 40px; flex: none;}

        /* --- è³‡è¨Šé æ¨£å¼ --- */
        .info-section {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .info-header {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 10px;
            border-bottom: 2px solid var(--accent);
            padding-bottom: 5px;
            display: inline-block;
        }
        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px dashed #eee;
        }
        .info-label { color: #888; font-size: 0.9em; }
        .info-value { font-weight: 500; text-align: right; }

        /* --- è¨˜å¸³æ¨£å¼ --- */
        .balance-card {
            background: linear-gradient(135deg, #2d3436, #000);
            color: white;
            padding: 20px;
            border-radius: 16px;
            text-align: center;
            margin-bottom: 20px;
        }
        .expense-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        /* --- åº•éƒ¨å°èˆª --- */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: var(--nav-height);
            background: white;
            display: flex;
            justify-content: space-around;
            align-items: center;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        .nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #b2bec3;
            font-size: 12px;
            background: none;
            border: none;
            cursor: pointer;
        }
        .nav-btn.active { color: var(--primary); }
        .nav-icon { font-size: 24px; margin-bottom: 4px; }

        /* --- Modal --- */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: white;
            width: 90%;
            max-width: 500px;
            border-radius: 16px;
            padding: 20px;
            max-height: 90vh;
            overflow-y: auto;
        }
        .form-control {
            width: 100%; padding: 10px; margin-bottom: 10px;
            border: 1px solid #ddd; border-radius: 8px;
        }
        .btn-full { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: bold; margin-top: 10px; cursor: pointer; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-cancel { background: #eee; color: #666; }

        /* FAB */
        .fab {
            position: fixed; bottom: 85px; right: 20px;
            width: 50px; height: 50px;
            background: var(--dark); color: white;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            cursor: pointer;
            z-index: 900;
        }
    </style>
</head>
<body>

    <div class="date-scroller" id="date-scroller">
        </div>

    <div id="page-itinerary" class="container active">
        <div id="itinerary-list">
            </div>
        <div class="fab" onclick="openItineraryModal()">+</div>
    </div>

    <div id="page-tools" class="container">
        <div class="info-section">
            <div class="info-header">âœˆï¸ èˆªç­è³‡è¨Š</div>
            <div class="info-row">
                <span class="info-label">å»ç¨‹ (12/23)</span>
                <span class="info-value">FD235 <br>KHH 18:00 - DMK 21:30</span>
            </div>
            </div>

        <div class="info-section">
            <div class="info-header">ğŸ¨ ä½å®¿è³‡è¨Š</div>
            <div class="info-row">
                <span class="info-label">12/23 - 12/25 (å”äººè¡—)</span>
                <span class="info-value">
                    <a href="https://maps.google.com/?q=B2+China+Town+Yaowarat+Premier+Hotel" target="_blank">B2 å”äººè¡—è€€è¯åŠ›</a>
                </span>
            </div>
            <div class="info-row">
                <span class="info-label">12/25 - 12/27 (é€šç¾…)</span>
                <span class="info-value">
                    <a href="https://maps.google.com/?q=Jasmine+59+Hotel" target="_blank">Jasmine 59 Hotel</a>
                </span>
            </div>
        </div>

        <div class="info-section">
            <div class="info-header">ğŸ†˜ ç·Šæ€¥è¯çµ¡</div>
            <div class="info-row">
                <span class="info-label">è§€å…‰è­¦å¯Ÿ</span>
                <span class="info-value">1155</span>
            </div>
            <div class="info-row">
                <span class="info-label">æ€¥æ•‘ä¸­å¿ƒ</span>
                <span class="info-value">1669</span>
            </div>
        </div>

        <div class="info-header" style="margin-top:20px;">ğŸ’° æ—…è²»è¨˜å¸³</div>
        <div class="balance-card">
            <div style="font-size: 0.9em; opacity: 0.8;">ç›®å‰ç¸½é–‹éŠ· (TWD)</div>
            <div style="font-size: 2.5em; font-weight: bold;" id="total-expense">0</div>
        </div>
        
        <div style="margin-bottom:15px; display:flex; gap:10px;">
             <button class="btn-full btn-primary" onclick="openExpenseModal()" style="margin:0;">è¨˜ä¸€ç­†</button>
             <button class="btn-full btn-cancel" onclick="openMemberModal()" style="margin:0;">è¨­å®šæˆå“¡</button>
        </div>

        <div id="expense-list">
            </div>
    </div>

    <div class="bottom-nav">
        <button class="nav-btn active" onclick="switchPage('itinerary', this)">
            <span class="nav-icon">ğŸ“…</span>
            <span>è¡Œç¨‹</span>
        </button>
        <button class="nav-btn" onclick="switchPage('tools', this)">
            <span class="nav-icon">ğŸ§³</span>
            <span>è³‡è¨Š & è¨˜å¸³</span>
        </button>
    </div>

    <div id="modal-itinerary" class="modal">
        <div class="modal-content">
            <h3>ç·¨è¼¯è¡Œç¨‹</h3>
            <input type="hidden" id="edit-id">
            <input type="date" id="input-date" class="form-control" value="2024-12-23">
            <input type="time" id="input-time" class="form-control">
            <select id="input-type" class="form-control">
                <option value="attraction">ğŸ¡ æ™¯é»</option>
                <option value="food">ğŸœ é¤å»³/ç¾é£Ÿ</option>
                <option value="transport">ğŸš• äº¤é€š/ç§»å‹•</option>
                <option value="hotel">ğŸ¨ é£¯åº—</option>
                <option value="flight">âœˆï¸ èˆªç­</option>
            </select>
            <input type="text" id="input-title" class="form-control" placeholder="æ¨™é¡Œ">
            <input type="text" id="input-location" class="form-control" placeholder="åœ°é» (ç”¨æ–¼å°èˆª)">
            <textarea id="input-desc" class="form-control" rows="3" placeholder="å‚™è¨»/æ”»ç•¥/é€£çµ"></textarea>
            <button class="btn-full btn-primary" onclick="saveItinerary()">å„²å­˜</button>
            <button class="btn-full btn-cancel" onclick="closeModal('modal-itinerary')">å–æ¶ˆ</button>
            <button class="btn-full" style="background:#ff7675; color:white;" onclick="deleteItinerary()">åˆªé™¤</button>
        </div>
    </div>

    <div id="modal-expense" class="modal">
        <div class="modal-content">
            <h3>è¨˜ä¸€ç­†</h3>
            <input type="text" id="exp-title" class="form-control" placeholder="é …ç›® (ä¾‹: æ™šé¤)">
            <div style="display:flex; gap:10px;">
                <input type="number" id="exp-amount" class="form-control" placeholder="é‡‘é¡">
                <select id="exp-currency" class="form-control" style="width:100px;" onchange="updateRate()">
                    <option value="THB">THB</option>
                    <option value="TWD">TWD</option>
                </select>
            </div>
            <input type="number" id="exp-rate" class="form-control" placeholder="åŒ¯ç‡ (1å¤–å¹£=?å°å¹£)" value="0.95">
            
            <label style="font-size:0.9em; font-weight:bold; display:block; margin-top:10px;">èª°å…ˆä»˜éŒ¢ï¼Ÿ</label>
            <select id="exp-payer" class="form-control"></select>

            <label style="font-size:0.9em; font-weight:bold; display:block; margin-top:10px;">åˆ†æ”¤è€…</label>
            <div id="exp-splitters" style="display:flex; flex-wrap:wrap; gap:10px; margin-bottom:15px;"></div>

            <button class="btn-full btn-primary" onclick="saveExpense()">å„²å­˜</button>
            <button class="btn-full btn-cancel" onclick="closeModal('modal-expense')">å–æ¶ˆ</button>
        </div>
    </div>

    <script>
        // --- 1. è³‡æ–™åˆå§‹åŒ– ---
        // é è¨­è¡Œç¨‹è³‡æ–™ (ä¾ç…§æ‚¨çš„è¦æ±‚ Hardcode)
        const defaultData = [
            // Day 1: 12/23
            {
                id: 1, date: "2024-12-23", time: "18:00", type: "flight",
                title: "é«˜é›„é£›æ›¼è°· (FD235)", location: "Don Mueang International Airport",
                desc: "âœˆï¸ é«˜é›„ 18:00 - å»Šæ›¼ 21:30\næŠµé”å¾Œç›´æ¥åŒ…è»Šå»é£¯åº—"
            },
            {
                id: 2, date: "2024-12-23", time: "22:30", type: "transport",
                title: "æ©Ÿå ´åŒ…è»Šè‡³é£¯åº—", location: "B2 China Town Yaowarat Premier Hotel",
                desc: "é è¨ˆæ²’å¡è»ŠåŠå°æ™‚åˆ°ã€‚\nå…¥ä½: B2 å”äººè¡—è€€è¯åŠ›å°Šå°šé£¯åº—"
            },
            {
                id: 3, date: "2024-12-23", time: "23:00", type: "food",
                title: "å”äººè¡—åƒå®µå¤œ", location: "Yaowarat Road",
                desc: "å¿…åƒæ”»ç•¥ï¼šç²¿æ±ã€æµ·é®®å¤§æ’æª”ã€‚\nåƒè€ƒ: è‰¾ç‘çµ²çš„åƒè²¨æ—¥å¸¸æ‡¶äººåŒ…"
            },
            // Day 2: 12/24
            {
                id: 4, date: "2024-12-24", time: "10:00", type: "attraction",
                title: "çŸ³é¾è»è·¯æ–‡é’æ•£ç­–", location: "Charoen Krung Road",
                desc: "æ–‡é’ç‰ˆä»‹ç´¹ã€è¡—é ­è—è¡“ã€è€å»ºç¯‰å·¡ç¦®"
            },
            {
                id: 5, date: "2024-12-24", time: "13:00", type: "attraction",
                title: "è‡¥ä½›å¯º", location: "Wat Pho",
                desc: "æ›¼è°·æœ€å¤è€å¯ºå»Ÿï¼Œè¨˜å¾—ä¸èƒ½ç©¿å¤ªéœ²"
            },
            {
                id: 6, date: "2024-12-24", time: "15:00", type: "attraction",
                title: "é„­ç‹å»Ÿ (é»æ˜å¯º)", location: "Wat Arun",
                desc: "æ­èˆ¹éå»ï¼Œç¶²ç¾æ‹ç…§è–åœ°"
            },
            {
                id: 7, date: "2024-12-24", time: "17:00", type: "food",
                title: "ç‹æœ—å¸‚å ´", location: "Wang Lang Market",
                desc: "åœ¨åœ°å°åƒé›†æ•£åœ°"
            },
            {
                id: 8, date: "2024-12-24", time: "19:00", type: "food",
                title: "River City éƒµè¼ªæ™šé¤", location: "River City Bangkok",
                desc: "äº«å—æ˜­æŠ«è€¶æ²³å¤œæ™¯"
            },
            // Day 3: 12/25
            {
                id: 9, date: "2024-12-25", time: "09:00", type: "food",
                title: "æ—©é¤ï¼šç›Šç”Ÿç”«è¨˜ æˆ– å®‰æ¨‚åœ’", location: "On Lok Yun",
                desc: "å”äººè¡—é™„è¿‘è€ç‰Œæ—©é¤ï¼Œæ¨è–¦å’–æ¤°åå¸"
            },
            {
                id: 10, date: "2024-12-25", time: "11:00", type: "attraction",
                title: "åµ©è¶Šè·¯ Song Wat", location: "Song Wat Road",
                desc: "è¿‘æœŸå¾ˆç´…çš„æ–‡å‰µè€è¡—"
            },
            {
                id: 11, date: "2024-12-25", time: "14:00", type: "attraction",
                title: "çŸ³é¾è»è·¯ (ä¸ŠåŠè·¯) & 32Bar", location: "32 Bar Bangkok",
                desc: "ä¸‹åˆèŒ¶æˆ–å°é…Œ"
            },
            {
                id: 12, date: "2024-12-25", time: "16:00", type: "attraction",
                title: "å”äººè¡—é€›é€›", location: "Yaowarat Road",
                desc: "æ„Ÿå—ç™½å¤©èˆ‡å¤œæ™šä¸åŒçš„æ°›åœ"
            },
            {
                id: 13, date: "2024-12-25", time: "19:00", type: "attraction",
                title: "è€ƒå±±è·¯ / ç™¾è²¨å…¬å¸", location: "Khaosan Road",
                desc: "Option: Iconsiam, Central World, Dusit Central Park"
            },
             // Day 4: 12/26
            {
                id: 14, date: "2024-12-26", time: "08:00", type: "transport",
                title: "åŒ…è»Šä¸€æ—¥éŠ", location: "B2 China Town Yaowarat Premier Hotel",
                desc: "é£¯åº—å¤§å»³é›†åˆå‡ºç™¼"
            },
            {
                id: 15, date: "2024-12-26", time: "10:00", type: "attraction",
                title: "ç¾åŠŸéµé“å¸‚å ´", location: "Maeklong Railway Market",
                desc: "çœ‹ç«è»Šç¶“éå¸‚é›†çš„å¥‡æ™¯"
            },
            {
                id: 16, date: "2024-12-26", time: "12:00", type: "attraction",
                title: "ä¸¹å«©èæœµæ°´ä¸Šå¸‚å ´", location: "Damnoen Saduak Floating Market",
                desc: "é«”é©—æ‰‹æ–èˆ¹"
            },
            {
                id: 17, date: "2024-12-26", time: "14:00", type: "attraction",
                title: "æ¨¹ä¸­å»Ÿ", location: "Wat Bang Kung",
                desc: "è¢«è©ææ¨¹åŒ…åœçš„å¯ºå»Ÿ"
            },
            {
                id: 18, date: "2024-12-26", time: "16:00", type: "transport",
                title: "å›ç¨‹æ›¼è°·", location: "Jasmine 59 Hotel",
                desc: "å›é£¯åº—ä¼‘æ¯æˆ–å»æŒ‰æ‘©/ç™¾è²¨å…¬å¸"
            }
        ];

        // ç‹€æ…‹ç®¡ç†
        let trips = JSON.parse(localStorage.getItem('bkk_trips_v2')) || defaultData;
        let expenses = JSON.parse(localStorage.getItem('bkk_expenses_v2')) || [];
        let members = JSON.parse(localStorage.getItem('bkk_members_v2')) || ['æˆ‘', 'æ—…ä¼´A'];
        
        let currentDate = "2024-12-23";
        let currentEditId = null;

        // --- 2. æ ¸å¿ƒåŠŸèƒ½å‡½å¼ ---

        function init() {
            renderDateScroller();
            renderItinerary();
            renderExpenseList();
            renderMemberOptions();
        }

        // æ¸²æŸ“æ—¥æœŸé¸å–®
        function renderDateScroller() {
            const dates = ["2024-12-23", "2024-12-24", "2024-12-25", "2024-12-26", "2024-12-27", "2024-12-28"];
            const scroller = document.getElementById('date-scroller');
            scroller.innerHTML = dates.map(date => {
                const day = new Date(date).getDay();
                const weekDays = ["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"];
                return `<div class="date-chip ${date === currentDate ? 'active' : ''}" 
                        onclick="setDate('${date}')">
                        ${date.slice(5)} (${weekDays[day]})
                        </div>`;
            }).join('');
        }

        function setDate(date) {
            currentDate = date;
            renderDateScroller();
            renderItinerary();
        }

        // æ¸²æŸ“è¡Œç¨‹å¡ç‰‡ (AI Highlights é‚è¼¯åœ¨æ­¤)
        function renderItinerary() {
            const list = document.getElementById('itinerary-list');
            const dayTrips = trips.filter(t => t.date === currentDate).sort((a,b) => a.time.localeCompare(b.time));
            
            if(dayTrips.length === 0) {
                list.innerHTML = `<div style="text-align:center; padding:40px; color:#999;">æœ¬æ—¥å°šç„¡è¡Œç¨‹<br>é»æ“Šå³ä¸‹è§’ + æ–°å¢</div>`;
                return;
            }

            list.innerHTML = dayTrips.map(item => {
                // è‡ªå‹•ç”Ÿæˆå°èˆªé€£çµ
                const mapLink = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.location || item.title)}`;
                
                // AI æ¨¡æ“¬åˆ†ææ–‡å­— (Highlighter)
                let processedDesc = item.desc;
                const keywords = ["å¿…åƒ", "FD235", "B2 å”äººè¡—", "Jasmine 59", "é ç´„", "æ”»ç•¥"];
                keywords.forEach(key => {
                    processedDesc = processedDesc.replace(new RegExp(key, 'g'), `<span class="highlight-tag">${key}</span>`);
                });
                // ä»£è™Ÿ Highlighting
                processedDesc = processedDesc.replace(/([A-Z0-9]{4,})/g, `<span class="highlight-code">$1</span>`);

                return `
                <div class="card type-${item.type}" onclick="editItem(${item.id})">
                    <div class="card-header">
                        <span class="time-badge">${item.time}</span>
                        <div class="weather-badge" onclick="event.stopPropagation(); window.open('https://weather.com/zh-TW/weather/today/l/THXX0002:1:TH', '_blank')">
                            â˜€ï¸ 30Â°C
                        </div>
                    </div>
                    <div class="card-title">${item.title}</div>
                    <div class="card-desc">${processedDesc}</div>
                    
                    <div class="card-actions">
                        <a href="${mapLink}" target="_blank" class="btn-action btn-nav" onclick="event.stopPropagation()">
                            ğŸš— å°èˆª
                        </a>
                        ${item.location ? `
                        <a href="https://www.google.com/search?q=${encodeURIComponent(item.title + ' æ”»ç•¥')}" target="_blank" class="btn-action btn-link" onclick="event.stopPropagation()">
                            ğŸ” æœæ”»ç•¥
                        </a>` : ''}
                    </div>
                </div>
                `;
            }).join('');
            
            localStorage.setItem('bkk_trips_v2', JSON.stringify(trips));
        }

        // --- 3. ç·¨è¼¯/æ–°å¢è¡Œç¨‹ ---
        function openItineraryModal() {
            currentEditId = null;
            document.getElementById('input-date').value = currentDate;
            document.getElementById('input-time').value = "10:00";
            document.getElementById('input-title').value = "";
            document.getElementById('input-location').value = "";
            document.getElementById('input-desc').value = "";
            document.getElementById('modal-itinerary').style.display = 'flex';
        }

        function editItem(id) {
            const item = trips.find(t => t.id === id);
            if(!item) return;
            currentEditId = id;
            document.getElementById('input-date').value = item.date;
            document.getElementById('input-time').value = item.time;
            document.getElementById('input-type').value = item.type;
            document.getElementById('input-title').value = item.title;
            document.getElementById('input-location').value = item.location;
            document.getElementById('input-desc').value = item.desc;
            document.getElementById('modal-itinerary').style.display = 'flex';
        }

        function saveItinerary() {
            const newItem = {
                id: currentEditId || Date.now(),
                date: document.getElementById('input-date').value,
                time: document.getElementById('input-time').value,
                type: document.getElementById('input-type').value,
                title: document.getElementById('input-title').value,
                location: document.getElementById('input-location').value,
                desc: document.getElementById('input-desc').value
            };

            if(currentEditId) {
                const idx = trips.findIndex(t => t.id === currentEditId);
                trips[idx] = newItem;
            } else {
                trips.push(newItem);
            }
            closeModal('modal-itinerary');
            setDate(newItem.date); // è·³è½‰åˆ°è©²æ—¥æœŸ
        }

        function deleteItinerary() {
            if(currentEditId && confirm("ç¢ºå®šåˆªé™¤æ­¤è¡Œç¨‹ï¼Ÿ")) {
                trips = trips.filter(t => t.id !== currentEditId);
                closeModal('modal-itinerary');
                renderItinerary();
            }
        }

        // --- 4. è¨˜å¸³é‚è¼¯ ---
        function renderMemberOptions() {
            const payerSelect = document.getElementById('exp-payer');
            const splitDiv = document.getElementById('exp-splitters');
            payerSelect.innerHTML = members.map(m => `<option value="${m}">${m}</option>`).join('');
            splitDiv.innerHTML = members.map(m => `
                <label style="background:#eee; padding:5px 10px; border-radius:15px; display:flex; align-items:center; gap:5px;">
                    <input type="checkbox" value="${m}" checked> ${m}
                </label>
            `).join('');
        }

        function openExpenseModal() {
            renderMemberOptions();
            document.getElementById('exp-title').value = '';
            document.getElementById('exp-amount').value = '';
            document.getElementById('modal-expense').style.display = 'flex';
        }

        function saveExpense() {
            const amount = parseFloat(document.getElementById('exp-amount').value);
            const rate = parseFloat(document.getElementById('exp-rate').value);
            const currency = document.getElementById('exp-currency').value;
            
            const splitters = Array.from(document.querySelectorAll('#exp-splitters input:checked')).map(cb => cb.value);
            
            if(!amount || splitters.length === 0) { alert("è«‹è¼¸å…¥é‡‘é¡ä¸¦è‡³å°‘é¸æ“‡ä¸€äººåˆ†æ”¤"); return; }

            const twdAmount = Math.round(amount * (currency === 'THB' ? rate : 1));

            expenses.push({
                id: Date.now(),
                title: document.getElementById('exp-title').value,
                amount: amount,
                currency: currency,
                twdAmount: twdAmount,
                payer: document.getElementById('exp-payer').value,
                splitters: splitters
            });

            localStorage.setItem('bkk_expenses_v2', JSON.stringify(expenses));
            renderExpenseList();
            closeModal('modal-expense');
        }

        function renderExpenseList() {
            const list = document.getElementById('expense-list');
            let total = 0;
            list.innerHTML = expenses.slice().reverse().map(e => {
                total += e.twdAmount;
                return `
                <div class="expense-item">
                    <div>
                        <div style="font-weight:bold;">${e.title}</div>
                        <div style="font-size:0.8em; color:#888;">${e.payer} ä»˜æ¬¾ / ${e.splitters.length}äººåˆ†</div>
                    </div>
                    <div style="text-align:right;">
                        <div style="color:var(--primary); font-weight:bold;">NT$ ${e.twdAmount}</div>
                        <div style="font-size:0.8em; color:#aaa;">${e.currency} ${e.amount}</div>
                    </div>
                </div>`;
            }).join('');
            document.getElementById('total-expense').innerText = total.toLocaleString();
        }

        function updateRate() {
            const curr = document.getElementById('exp-currency').value;
            document.getElementById('exp-rate').value = (curr === 'TWD') ? 1 : 0.95;
        }

        // --- 5. UI å·¥å…· ---
        function switchPage(pageId, btn) {
            document.querySelectorAll('.container').forEach(el => el.classList.remove('active'));
            document.getElementById('page-' + pageId).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            if(btn) btn.classList.add('active');
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        // å•Ÿå‹•
        init();

    </script>
</body>
</html>
